<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
	<meta name="viewport" content="width=500">
	<title>LED 设置</title>
	<script>
    var d=document,laprev=55,maxB=1,maxM=5000,maxPB=4096,bquot=0; //maximum bytes for LED allocation: 5kB for 8266, 32kB for 32
		function H()
		{
			window.open("https://github.com/Aircoookie/WLED/wiki/Settings#led-settings");
		}
		function B()
		{
			window.open("/settings","_self");
    }
    function gId(n){return d.getElementById(n);}
    function off(n){
      d.getElementsByName(n)[0].value = -1;
    }
    function bLimits(b,p,m) {
      maxB = b; maxM = m; maxPB = p;
    }
    function pinsOK() {
      var LCs = d.getElementsByTagName("input");
      for (i=0; i<LCs.length; i++) {
        var nm = LCs[i].name.substring(0,2);
        //check for pin conflicts
        if (nm=="L0" || nm=="L1" || nm=="L2" || nm=="L3" || nm=="L4" || nm=="RL" || nm=="BT" || nm=="IR")
          if (LCs[i].value!="" && LCs[i].value!="-1") {
            if (d.um_p && d.um_p.some((e)=>e==parseInt(LCs[i].value,10))) {alert(`抱歉, 针脚 ${JSON.stringify(d.um_p)} 不能用。`);LCs[i].value="";LCs[i].focus();return false;}
            else if (LCs[i].value > 5 && LCs[i].value < 12) {alert("抱歉，6-11针脚不能用");LCs[i].value="";LCs[i].focus();return false;}
            for (j=i+1; j<LCs.length; j++)
            {
              var n2 = LCs[j].name.substring(0,2);
              if (n2=="L0" || n2=="L1" || n2=="L2" || n2=="L3" || n2=="L4" || n2=="RL" || n2=="BT" || n2=="IR")
                if (LCs[j].value!="" && LCs[i].value==LCs[j].value) {alert(`针脚冲突 ${nm}/${n2}!`);LCs[j].value="";LCs[j].focus();return false;}
            }
          }
      }
      return true;
    }
    function trySubmit(e) {
      e.preventDefault();
      if (!pinsOK()) {e.stopPropagation();return false;} // Prevent form submission and contact with server
      if (bquot > 100) {var msg = "LED 太多了！"; if (maxM < 10000) msg += "\n\r用 ESP32吧。"; alert(msg);}
      if (d.Sf.checkValidity()) d.Sf.submit(); //https://stackoverflow.com/q/37323914
    }
		function S(){GetV();setABL();}
    function enABL()
    {
      var en = gId('able').checked;
      d.Sf.LA.value = (en) ? laprev:0;
      gId('abl').style.display = (en) ? 'inline':'none';
      gId('psu2').style.display = (en) ? 'inline':'none';
      if (d.Sf.LA.value > 0) setABL();
    }
    function enLA()
    {
      var val = d.Sf.LAsel.value;
      d.Sf.LA.value = val;
      gId('LAdis').style.display = (val == 50) ? 'inline':'none';
      UI();
    }
    function setABL()
    {
      gId('able').checked = true;
      d.Sf.LAsel.value = 50;
      switch (parseInt(d.Sf.LA.value)) {
        case 0: gId('able').checked = false; enABL(); break;
        case 30: d.Sf.LAsel.value = 30; break;
        case 35: d.Sf.LAsel.value = 35; break;
        case 55: d.Sf.LAsel.value = 55; break;
        case 255: d.Sf.LAsel.value = 255; break;
        default: gId('LAdis').style.display = 'inline';
      }
      gId('m1').innerHTML = maxM;
      d.getElementsByName("Sf")[0].addEventListener("submit", trySubmit);
      UI();
    }
    //returns mem usage
    function getMem(type, len, p0) {
      if (type < 32) {
        if (maxM < 10000 && p0==3) {    //8266 DMA uses 5x the mem
          if (type > 29) return len*20; //RGBW
          return len*15;
        } else if (maxM >= 10000) //ESP32 RMT uses double buffer?
        {
          if (type > 29) return len*8; //RGBW
          return len*6;
        }
        if (type > 29) return len*4; //RGBW
        return len*3;
      }
      if (type > 31 && type < 48) return 5;
      if (type == 44 || type == 45) return len*4; //RGBW
      return len*3;
    }
		function UI(change=false)
		{
      var isRGBW = false, memu = 0;

      gId('ampwarning').style.display = (d.Sf.MA.value > 7200) ? 'inline':'none';

	    if (d.Sf.LA.value == 255) laprev = 12;
	    else if (d.Sf.LA.value > 0) laprev = d.Sf.LA.value;

      var s = d.getElementsByTagName("select");
      for (i=0; i<s.length; i++) {
        if (s[i].name.substring(0,2)=="LT") {
          n=s[i].name.substring(2);
          var type = parseInt(s[i].value,10);
          gId("p0d"+n).innerHTML = (type > 49) ? "Data:" : (type >41) ? "Pins:" : "Pin:";
          gId("p1d"+n).innerHTML = (type > 49) ? "Clk:" : "";
          var LK = d.getElementsByName("L1"+n)[0];

          memu += getMem(type, d.getElementsByName("LC"+n)[0].value, d.getElementsByName("L0"+n)[0].value);

          for (p=1; p<5; p++) {
            var LK = d.getElementsByName("L"+p+n)[0];
            if (!LK) continue;
            if ((type>49 && p==1) || (type>41 && type < 50 && (p+40 < type))) // TYPE_xxxx values from const.h
            {
              LK.style.display = "inline";
              LK.required = true;
            } else {
              LK.style.display = "none";
              LK.required = false;
              LK.value="";
            }
          }
          if (type == 30 || type == 31 || (type > 40 && type < 46 && type != 43)) isRGBW = true;
          gId("dig"+n).style.display = (type > 31 && type < 48) ? "none":"inline";
          gId("psd"+n).innerHTML = (type > 31 && type < 48) ? "Index:":"Start:";
        }
      }

      var myC = d.querySelectorAll('.wc'),
			l = myC.length;
			for (i = 0; i < l; i++) {
				myC[i].style.display = (isRGBW) ? 'inline':'none';
			}

      if (d.activeElement == d.getElementsByName("LC")[0]) {
        var o = d.getElementsByClassName("iST");
        var i = o.length;
        if (i == 1) d.getElementsByName("LC0")[0].value = d.getElementsByName("LC")[0].value;
      }

      var LCs = d.getElementsByTagName("input");
      var sLC = 0, maxLC = 0;
      for (i=0; i<LCs.length; i++) {
        var nm = LCs[i].name.substring(0,2);
        if (nm=="LC" && LCs[i].name !== "LC") {
          var n=LCs[i].name.substring(2);
          var c=parseInt(LCs[i].value,10);
          if(gId("ls"+n).readOnly) gId("ls"+n).value=sLC;
          if(c){sLC+=c;if(c>maxLC)maxLC=c;}
          continue;
        }
        if (nm=="L0" || nm=="L1") {
          var lc=d.getElementsByName("LC"+LCs[i].name.substring(2))[0];
          lc.max=maxPB;
        }
        if (nm=="L0" || nm=="L1" || nm=="L2" || nm=="L3" || nm=="L4" || nm=="RL" || nm=="BT" || nm=="IR")
          if (LCs[i].value!="" && LCs[i].value!="-1") {
            var p = [];
            if (d.um_p && Array.isArray(d.um_p)) for (k=0;k<d.um_p.length;k++) p.push(d.um_p[k]);
            for (j=0; j<LCs.length; j++) {
              if (i==j) continue;
              var n2 = LCs[j].name.substring(0,2);
              if (n2=="L0" || n2=="L1" || n2=="L2" || n2=="L3" || n2=="L4" || n2=="RL" || n2=="BT" || n2=="IR")
                if (LCs[j].value!="" && LCs[j].value!="-1") p.push(parseInt(LCs[j].value,10));
            }
            if (p.some((e)=>e==parseInt(LCs[i].value,10))) LCs[i].style.color="red"; else LCs[i].style.color="#fff";
          }
      }

      gId('m0').innerHTML = memu;
      bquot = memu / maxM * 100;
      gId('dbar').style.background = `linear-gradient(90deg, ${bquot > 60 ? (bquot > 90 ? "red":"orange"):"#ccc"} 0 ${bquot}%%, #444 ${bquot}%% 100%%)`;
      gId('ledwarning').style.display = (sLC > maxPB || maxLC > 800 || bquot > 80) ? 'inline':'none';
      gId('ledwarning').style.color = (sLC > maxPB || maxLC > maxPB || bquot > 100) ? 'red':'orange';
      gId('wreason').innerHTML = (bquot > 80) ? "80% of max. LED memory" +(bquot>100 ? ` (<b>WARNING: Using over ${maxM}B!</b>)` : "") : "800 LEDs per pin";

      var val = Math.ceil((100 + sLC * laprev)/500)/2;
			val = (val > 5) ? Math.ceil(val) : val;
			var s = "";
      var is12V = (d.Sf.LAsel.value == 30);
      var isWS2815 = (d.Sf.LAsel.value == 255);
			if (val < 1.02 && !is12V && !isWS2815)
			{
				s = "ESP 5V pin with 1A USB supply";
			} else
			{
        		s += is12V ? "12V ": isWS2815 ? "WS2815 12V " : "5V ";
				s += val;
				s += "A supply connected to LEDs";
			}
      var val2 = Math.ceil((100 + sLC * laprev)/1500)/2;
      val2 = (val2 > 5) ? Math.ceil(val2) : val2;
      var s2 = "(for most effects, ~";
      s2 += val2;
      s2 += "A is enough)<br>";
			gId('psu').innerHTML = s;
      gId('psu2').innerHTML = isWS2815 ? "" : s2;
    }
    function lastEnd(i) {
      if (i<1) return 0;
      v = parseInt(d.getElementsByName("LS"+(i-1))[0].value) + parseInt(d.getElementsByName("LC"+(i-1))[0].value);
      var type = parseInt(d.getElementsByName("LT"+(i-1))[0].value);
      if (type > 31 && type < 48) v = 1; //PWM busses
      if (isNaN(v)) return 0;
      return v;
    }
    function addLEDs(n)
    {
      if (n>1) {maxB=n; gId("+").style.display="inline"; return;}

      var o = d.getElementsByClassName("iST");
      var i = o.length;

      if ((n==1 && i>=maxB) || (n==-1 && i==0)) return;

      var f = gId("mLC");
      if (n==1) {
// npm run build has trouble minimizing spaces inside string
        var cn = `<div class="iST">
${i>0?'<hr style="width:260px">':''}
${i+1}:
<select name="LT${i}" onchange="UI()">
<option value="22">WS281x</option>
<option value="30">SK6812 RGBW</option>
<option value="31">TM1814</option>
<option value="24">400kHz</option>
<option value="50">WS2801</option>
<option value="51">APA102</option>
<option value="52">LPD8806</option>
<option value="53">P9813</option>
<option value="41">PWM White</option>
<option value="42">PWM WWCW</option>
<option value="43">PWM RGB</option>
<option value="44">PWM RGBW</option>
<option value="45">PWM RGBWC</option>
</select>&nbsp;
Color Order:
<select name="CO${i}">
<option value="0">GRB</option>
<option value="1">RGB</option>
<option value="2">BRG</option>
<option value="3">RBG</option>
<option value="4">BGR</option>
<option value="5">GBR</option>
</select><br>
<span id="p0d${i}">Pin:</span> <input type="number" class="xs" name="L0${i}" min="0" max="33" required onchange="UI()"/>
<span id="p1d${i}">Clock:</span> <input type="number" class="xs" name="L1${i}" min="0" max="33" onchange="UI()"/>
<span id="p2d${i}"></span><input type="number" class="xs" name="L2${i}" min="0" max="33" onchange="UI()"/>
<span id="p3d${i}"></span><input type="number" class="xs" name="L3${i}" min="0" max="33" onchange="UI()"/>
<span id="p4d${i}"></span><input type="number" class="xs" name="L4${i}" min="0" max="33" onchange="UI()"/>
<br>
<span id="psd${i}">Start:</span> <input type="number" name="LS${i}" id="ls${i}" min="0" max="8191" value="${lastEnd(i)}" required />&nbsp;
<div id="dig${i}" style="display:inline">
Count: <input type="number" name="LC${i}" min="0" max="${maxPB}" value="1" required oninput="UI()" /><br>
Reverse (rotated 180°): <input type="checkbox" name="CV${i}">
&nbsp;Skip 1<sup>st</sup> LED: <input id="sl${i}" type="checkbox" name="SL${i}"><br>
</div>
</div>`;
        f.insertAdjacentHTML("beforeend", cn);
      }
      if (n==-1) {
        o[--i].remove();--i;
      }

      gId("+").style.display = (i<maxB-1) ? "inline":"none";
      gId("-").style.display = (i>0) ? "inline":"none";

      UI();
    }
    function addBtn(i,p,t) {
      var c = gId("btns").innerHTML;
      var bt = "BT" + i;
      var be = "BE" + i;
      c += `Button ${i} pin: <input type="number" class="xs" min="-1" max="40" name="${bt}" onchange="UI()" value="${p}">&nbsp;`;
      c += `<select name="${be}">`
      c += `<option value="0" ${t==0?"selected":""}>Disabled</option>`;
      c += `<option value="2" ${t==2?"selected":""}>Pushbutton</option>`;
      c += `<option value="3" ${t==3?"selected":""}>Push inverted</option>`;
      c += `<option value="4" ${t==4?"selected":""}>Switch</option>`;
      c += `<option value="5" ${t==4?"selected":""}>Switch inverted</option>`;
      c += `<option value="6" ${t==6?"selected":""}>Touch</option>`;
      c += `<option value="7" ${t==7?"selected":""}>Analog</option>`;
      c += `</select>`;
      c += `<span style="cursor: pointer;" onclick="off('${bt}')">&nbsp;&#215;</span><br>`;
      gId("btns").innerHTML = c;
    }
		function GetV()
		{
      //values injected by server while sending HTML
      //maxM=5000;maxPB=1536;d.um_p=[1,6,7,8,9,10,11];addLEDs(3);d.Sf.LC.value=250;addLEDs(1);d.Sf.L00.value=2;d.Sf.L10.value=0;d.Sf.LC0.value=250;d.Sf.LT0.value=22;d.Sf.CO0.value=0;d.Sf.LS0.value=0;d.Sf.LS0.checked=0;d.Sf.MA.value=5400;d.Sf.LA.value=55;d.getElementsByClassName("pow")[0].innerHTML="350mA";d.Sf.CA.value=40;d.Sf.AW.value=3;d.Sf.BO.checked=0;d.Sf.BP.value=3;d.Sf.GB.checked=0;d.Sf.GC.checked=1;d.Sf.TF.checked=1;d.Sf.TD.value=700;d.Sf.PF.checked=0;d.Sf.BF.value=64;d.Sf.TB.value=0;d.Sf.TL.value=60;d.Sf.TW.value=1;d.Sf.PB.selectedIndex=0;d.Sf.RL.value=12;d.Sf.RM.checked=0;addBtn(0,0,2);addBtn(1,3,4);addBtn(2,-1,0);d.Sf.IR.value=-1;
    }
	</script>
	<style>
		@import url("style.css");
	</style>
</head>
<body onload="S()">
	<form id="form_s" name="Sf" method="post">
		<div class="helpB"><button type="button" onclick="H()">?</button></div>
		<button type="button" onclick="B()">返回</button><button type="submit">保存</button><hr>
    <h2>LED &amp; 硬件设置</h2>
    LED总计数： <input name="LC" id="LC" type="number" min="1" max="8192" oninput="UI()" required><br>
    <i>最亮白色的推荐电源：</i><br>
    <b><span id="psu">?</span></b><br>
    <span id="psu2"><br></span>
    <br>
    启用自动亮度限制器： <input type="checkbox" name="ABen" onchange="enABL()" id="able"><br>
    <div id="abl">
      最大电流： <input name="MA" type="number" class="l" min="250" max="65000" oninput="UI()" required> mA<br>
      <div id="ampwarning" style="color: orange; display: none;">
        &#9888; 你的电源提供大电流。<br>
        为了提高安装的安全性，<br>
        请使用粗电缆，<br>
        多个电源注入点和一个保险丝！<br>
      </div>
      <i>自动限制亮度以保持接近极限。<br>
      保持 &lt;1A 如果直接从ESP 5V引脚为LED供电<br>
      如果您使用的是外部电源，请输入其额定值。<br>
      (当前估计使用量： <span class="pow">未知</span>)</i><br><br>
      LED电压（单个LED的最大电流）：<br>
      <select name="LAsel" onchange="enLA()">
        <option value="55" selected>5V 默认 (55mA)</option>
        <option value="35">5V 高效 (35mA)</option>
        <option value="30">12V (30mA)</option>
        <option value="255">WS2815 (12mA)</option>
        <option value="50">自定义</option>
      </select><br>
      <span id="LAdis" style="display: none;">每个LED的自定义最大电流： <input name="LA" type="number" min="0" max="255" id="la" oninput="UI()" required> mA<br></span>
      <i>如果您不确定LED的类型，请保留默认值。</i><br>
    </div>
    <h3>硬件设置</h3>
    <div id="mLC">LED输出：</div>
    <button type="button" id="+" onclick="addLEDs(1)" style="display:none;border-radius:20px;height:36px;">+</button>
    <button type="button" id="-" onclick="addLEDs(-1)" style="display:none;border-radius:20px;width:36px;height:36px;">-</button><br>
    LED内存使用率: <span id="m0">0</span> / <span id="m1">?</span> B<br>
    <div id="dbar" style="display:inline-block; width: 100px; height: 10px; border-radius: 20px;"></div><br>
    <div id="ledwarning" style="color: orange; display: none;">
      &#9888; 您可能会遇到稳定性或滞后问题。<br>
      使用少于 <span id="wreason">800 LED在一个引脚</span> 会好很多!<br>
    </div><hr style="width:260px">
    <div id="btns"></div>
    触摸阈值: <input type="number" class="s" min="0" max="100" name="TT" required><br>
    IR引脚: <input type="number" class="xs" min="-1" max="40" name="IR" onchange="UI()">&nbsp;<select name="IT">
    <option value=0>禁用遥控</option>
    <option value=1>24-key RGB</option>
    <option value=2>24-key with CT</option>
    <option value=3>40-key blue</option>
    <option value=4>44-key RGB</option>
    <option value=5>21-key RGB</option>
    <option value=6>6-key black</option>
    <option value=7>9-key red</option>
    <option value=8>JSON 遥控</option>
    </select><span style="cursor: pointer;" onclick="关闭('IR')">&nbsp;&#215;</span><br>
    <a href="https://github.com/Aircoookie/WLED/wiki/Infrared-Control" target="_blank">IR 信息</a><br>
    继电器引脚: <input type="number" class="xs" min="-1" max="33" name="RL" onchange="UI()"> 转换 <input type="checkbox" name="RM"><span style="cursor: pointer;" onclick="关闭('RL')">&nbsp;&#215;</span><br>
    <hr style="width:260px">
		<h3>默认</h3>
		上电/复位后打开LED： <input type="checkbox" name="BO"><br>
    默认亮度：<input name="CA" type="number" class="s" min="0" max="255" required> (0-255)<br><br>
    应用预设 <input name="BP" type="number" class="s" min="0" max="250" required> 启动时（0 为使用默认值）
    <br><br>
		对颜色使用Gamma校正： <input type="checkbox" name="GC"> (强烈推荐)<br>
		对亮度使用Gamma校正： <input type="checkbox" name="GB"> (不推荐)<br><br>
		亮度系数： <input name="BF" type="number" class="s" min="1" max="255" required> %
		<h3>过渡</h3>
		交叉淡入：<input type="checkbox" name="TF"><br>
		过渡时间：<input name="TD" type="number" class="l" min="0" max="65500"> ms<br>
		启用调色板转换： <input type="checkbox" name="PF">
		<h3>定时灯</h3>
		默认持续时间： <input name="TL" type="number" class="s" min="1" max="255" required> 分<br>
		默认目标亮度： <input name="TB" type="number" class="s" min="0" max="255" required><br>
		模式：
    <select name="TW">
			<option value="0">等待并设置</option>
			<option value="1">褪色</option>
			<option value="2">彩色褪色</option>
			<option value="3">日出</option>
		</select>
    <h3>高级</h3>
		调色板混合：
		<select name="PB">
			<option value="0">线性（移动时环绕）</option>
			<option value="1">性（始终环绕）</option>
			<option value="2">线性（从不缠绕）</option>
			<option value="3">无（不推荐）</option>
		</select><br>
    <span class="wc">
      从RGB自动计算白色通道：<br>
      <select name="AW">
        <option value=0>没有</option>
        <option value=1>明亮点</option>
        <option value=2>精准</option>
        <option value=3>双重</option>
        <option value=4>遗留</option>
      </select>
    <br></span><hr>
		<button type="button" onclick="B()">返回</button><button type="submit">保存</button>
	</form>
</body>
</html>
